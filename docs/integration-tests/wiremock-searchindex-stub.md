# Search index stub

As part of conducting integration testing with our UseCase that speaks to Azure SearchIndex, we require a way to integrate **as close** to our Search Index of choice; Azure Search, which is a PaaS service that provides server-side searching, paging and filtering.

Azure Search does not provide local options to emulate (such [as a Docker like they do for CosmosDB](https://learn.microsoft.com/en-us/azure/cosmos-db/emulator-linux)), their public API surface for their Azure Search Indexes.

## Notes

- We use the Azure.Documents.Search SDK to call the Azure Search APIs which **requires** HTTPS
- We prefer to not replace services in `IServiceCollection` to get as close to a partial-integration test with all application parts
- We need the ability to stub responses on the stub-server based call parameters. e.g /indexes/{index}/

## Options

1. Stub the expected contract from the Search Indexes

## Advantages

### As close to a "full" integration test

- No adjustment of services in the application's DI
- Complete calls over HTTP

## Cons

### Cost: Maintain parity with our stubbed index contract, to the AI Search version

// TODO looks like AISearch versions their Client, which passes a paticular ?version= to AISearch
// TODO should have system tests after deployment to exercise?

### Cost: Maintain infrastructure to create and trust a local https stub-server in CI AND enforces need for Linux CI runner for host-certificates

On Linux, `.NET` uses `openssl` to verify certificate validity.

We'd need to generate a valid certificate (so that HTTPS could continue) so that the IntegrationTests could reach the stub-server using `SearchClient` and trust the certificate returned from the stub-server.

### Cost: We could not use a self-signed cert

Self-signed certs they lack a trust Chain. The certificates generated by dotnet dev-certs https are self-signed and not issued by a trusted CA. The Azure SDKs (like Azure.Search.Documents) use HttpClient with strict TLS validation. They do not bypass certificate errors, and they do not trust self-signed certs unless the root is explicitly trusted.Search.Documents SearchClient

This causes .NET's HttpClient (used by Azure SDKs) to reject them with:

```text
    System.Security.Authentication.AuthenticationException: The remote certificate is invalid because of errors in the certificate chain: UntrustedRoot
```

This is confirmed in [Microsoft's documentation](https://learn.microsoft.com/en-us/dotnet/core/tools/dotnet-dev-certs), which states:

```text
    "By default, the newly created certificate is not trusted. To trust the certificate, use the --trust option."
```

So usage of `dotnet dev-certs` OR manually generating the self-signed cert with `openssl` like below, fails

```sh
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout localhost.key -out localhost.crt -config localhost.conf -subj /CN=localhost

openssl x509 -in localhost.crt -text -noout

sudo cp localhost.crt /usr/local/share/ca-certificates/localhost.crt

sudo update-ca-certificates
```

#### Cost: We did not want to adjust source code

Some suggestions recommend replacing the SearchClient with another in `ServiceCollection` that accepts any server certificate. This violates the desire to not replace application-services to get a partial integration test.

#### Cost: Maintain fixture code for stub-server

2. Stubbing in-memory

We could // TODO
